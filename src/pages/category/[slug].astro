---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import CategoryMenu from '../../components/CategoryMenu.astro';
import { siteConfig, getCategoryBySlug } from '../../config';
import { formatDate, getSlug } from '../../lib/utils';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const categories = [...new Set(allPosts.map((p) => p.data.category))];

  return categories.map((category) => ({
    params: { slug: category },
    props: {
      category,
      posts: allPosts
        .filter((p) => p.data.category === category)
        .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()),
    },
  }));
}

const { category, posts } = Astro.props;
const categoryObj = getCategoryBySlug(category);
const categoryName = categoryObj?.name ?? category;
const currentPath = `/category/${category}/`;
---

<BaseLayout title={categoryName}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "http://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: [
        {
          "@type": "ListItem",
          position: 1,
          item: { "@id": siteConfig.siteUrl, name: "HOME" },
        },
        {
          "@type": "ListItem",
          position: 2,
          item: { "@id": `${siteConfig.siteUrl}/${category}`, name: categoryName },
        },
      ],
    })} />
  </Fragment>

  <CategoryMenu currentPath={currentPath} />
  <h1 class="category-heading">{categoryName}</h1>
  {posts.map((post) => (
    <PostCard
      slug={getSlug(post.id)}
      title={post.data.title}
      date={formatDate(post.data.date)}
      emoji={post.data.emoji}
      category={post.data.category}
    />
  ))}
</BaseLayout>

<style>
  .category-heading {
    margin: 2rem 0 0.5em;
    font-size: 32px;
    color: #fff;
    font-weight: 700;
    line-height: 44px;
    letter-spacing: 1px;
  }
</style>
